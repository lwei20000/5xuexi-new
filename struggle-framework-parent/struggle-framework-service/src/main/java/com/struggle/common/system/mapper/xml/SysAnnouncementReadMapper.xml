<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.struggle.common.system.mapper.SysAnnouncementReadMapper">

    <!-- 分页查询 -->
    <select id="selectPageRel" resultType="com.struggle.common.system.entity.SysAnnouncementRead">
        SELECT a.*,rea.id,rea.create_time from (
        SELECT DISTINCT su.user_id,su.username,su.realname,r.announcement_id from sys_announcement_receive r
        ,(select u.user_id,u.username,u.realname,t.create_time as tenant_user_create_time from sys_user_tenant t join sys_user u on t.user_id = u.user_id and u.deleted=0) su
        WHERE r.deleted=0
          and (
                (r.receive_type ='1' and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= su.tenant_user_create_time)))
                or (r.receive_type ='4' and su.user_id = r.receive_id )
                or (r.receive_type ='2' and su.user_id in(SELECT o.user_id from sys_user_org o WHERE o.org_id = r.receive_id and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= o.create_time))))
                or (r.receive_type ='3' and su.user_id in(SELECT ro.user_id from sys_user_role ro WHERE ro.role_id = r.receive_id and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= ro.create_time))))
                or (r.receive_type ='5' and su.user_id in(SELECT op.user_id from sys_user_group op WHERE op.group_id = r.receive_id and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= op.create_time))))
             )
        ) a
        left join sys_announcement_read rea on rea.deleted=0 and rea.announcement_id = a.announcement_id and  rea.user_id = a.user_id
        <where>
            <if test="param.announcementId != null">
                AND a.announcement_id = #{param.announcementId}
            </if>
            <if test="param.userId != null">
                AND a.user_id = #{param.userId}
            </if>
            <if test="param.username != null">
                AND a.username = #{param.username}
            </if>
            <if test="param.realname != null">
                AND a.realname = #{param.realname}
            </if>
            <if test="param.hasRead != null">
                AND if(rea.id,1,0) =  #{param.hasRead}
            </if>
        </where>
    </select>

    <select id="_selectCount" resultType="java.util.Map">
        SELECT a.announcement_id announcementId,count(1) num from (
        SELECT DISTINCT su.user_id,r.announcement_id from sys_announcement_receive r
        ,(select u.user_id,t.create_time as tenant_user_create_time from sys_user_tenant t join sys_user u on t.user_id = u.user_id and u.deleted=0) su
        WHERE r.deleted=0
          and (
                (r.receive_type ='1' and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= su.tenant_user_create_time)))
                or (r.receive_type ='4' and su.user_id = r.receive_id )
                or (r.receive_type ='2' and su.user_id in(SELECT o.user_id from sys_user_org o WHERE o.org_id = r.receive_id and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= o.create_time))))
                or (r.receive_type ='3' and su.user_id in(SELECT ro.user_id from sys_user_role ro WHERE ro.role_id = r.receive_id and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= ro.create_time))))
                or (r.receive_type ='5' and su.user_id in(SELECT op.user_id from sys_user_group op WHERE op.group_id = r.receive_id and (r.add_newly =1 or (r.add_newly=0 and r.create_time >= op.create_time))))
            )
        ) a
        <if test="param.hasRead != null">
        left join sys_announcement_read rea on rea.deleted=0 and rea.announcement_id = a.announcement_id and  rea.user_id = a.user_id
        </if>
        <where>
            <if test="param.announcementId != null">
                AND a.announcement_id = #{param.announcementId}
            </if>

            <if test="param.announcementIds != null and param.announcementIds.size()>0">
                AND a.announcement_id in
                <foreach collection="param.announcementIds" open="(" close=")" separator="," item="announcementId">
                    #{announcementId}
                </foreach>
            </if>

            <if test="param.userId != null">
                AND a.user_id = #{param.userId}
            </if>
            <if test="param.hasRead != null">
                AND if(rea.id,1,0) =  #{param.hasRead}
            </if>
        </where>
        group by a.announcement_id
    </select>
</mapper>